library(readr)
X2019 <- read_csv("2019.csv")
View(X2019)
library(readr)
X2018 <- read_csv("2018.csv")
X2019 <- read_csv("2019.csv")
X2020 <- read_csv("2020.csv")
X2021 <- read_csv("2021.csv")
X2022 <- read_csv("2022.csv")
X2023 <- read_csv("2023.csv")
library(dplyr)
death_all <- bind_rows(
X2018,
X2019,
X2020,
X2021,
X2022,
X2023
)
View(death_all)
library(readr)
weekly_temp <- read_csv("weekly_temp.csv")
View(weekly_temp)
weekly_temp <- read_csv("weekly_temp.csv")
write.csv(death_all,"death_all.csv")
cdc_clean <- cdc %>%
rename(
state = State,
deaths = Deaths   # change to your actual mortality column name
) %>%
mutate(
week_end   = as.Date(`Week Ending Date`),      # adjust column name
week_start = week_end - 6                      # assume weeks are Mon–Sun
)
cdc_clean <- death_all %>%
rename(
state = State,
deaths = Deaths   # change to your actual mortality column name
) %>%
mutate(
week_end   = as.Date(`Week Ending Date`),      # adjust column name
week_start = week_end - 6                      # assume weeks are Mon–Sun
)
glimpse(death_all)
glimpse(death_all)
cdc_clean <- death_all %>%
rename(
state = Residence State,
cdc <- deaht_all %>%   # <-- replace with your object name
rename(
state = `Residence State`,
week_code = `MMWR Week Code`,
death_count = Deaths
) %>%
# Make sure week_code is formatted exactly like NOAA
mutate(
week_code = str_replace(week_code, " Week ", "/"),
week_code = str_extract(week_code, "\\d{4}/\\d{2}")  # keep only YYYY/WW
)
cdc <- death_all %>%   # <-- replace with your object name
rename(
state = `Residence State`,
week_code = `MMWR Week Code`,
death_count = Deaths
) %>%
# Make sure week_code is formatted exactly like NOAA
mutate(
week_code = str_replace(week_code, " Week ", "/"),
week_code = str_extract(week_code, "\\d{4}/\\d{2}")  # keep only YYYY/WW
)
library(stringr)
cdc <- death_all %>%   # <-- replace with your object name
rename(
state = `Residence State`,
week_code = `MMWR Week Code`,
death_count = Deaths
) %>%
# Make sure week_code is formatted exactly like NOAA
mutate(
week_code = str_replace(week_code, " Week ", "/"),
week_code = str_extract(week_code, "\\d{4}/\\d{2}")  # keep only YYYY/WW
)
View(weekly_temp)
noaa <- weekly_temp %>%
mutate(
state = as.character(state),
week_code = as.character(week_start)
)
merged <- cdc %>%
left_join(noaa , by = c("state", "week_code"))
glimpse(merged)
merged <- merged %>%
mutate(
age_group3 = case_when(
`Ten-Year Age Groups Code` %in% c("Under 1 year", "1-4", "5-14") ~ "<15",
`Ten-Year Age Groups Code` %in% c("15-24", "25-34", "35-44", "45-54", "55-64") ~ "15-64",
`Ten-Year Age Groups Code` %in% c("65-74", "75-84", "85+") ~ "65+",
TRUE ~ NA_character_
),
age_group3 = factor(age_group3, levels = c("<15", "15-64", "65+"))
)
glimpse(merged)
clean_df <- merged %>%
select(
state,
week_code,
week_start,
Deaths,
tmean_week_C,
tmean_week_F,
age_group3
)
clean_df <- merged %>%
select(
state,
week_code,
week_start,
death_count,
tmean_week_C,
tmean_week_F,
age_group3
)
write.csv(clean_df,"weatherAge.csv")
glimpse(clean_df)
glimpse(noaa)
cdc <- death_all %>%   # <-- replace with your object name
rename(
state = `Residence State`,
week_code = `MMWR Week Code`,
death_count = Deaths
) %>%
# Make sure week_code is formatted exactly like NOAA
mutate(
year = as.integer(str_sub(week_code, 1, 4)),
week = as.integer(str_sub(week_code, 6, 7)),
week_start = MMWRweek2Date(MMWRyear = year, MMWRweek = week)
)
library(lubridate)
cdc <- death_all %>%   # <-- replace with your object name
rename(
state = `Residence State`,
week_code = `MMWR Week Code`,
death_count = Deaths
) %>%
# Make sure week_code is formatted exactly like NOAA
mutate(
year = as.integer(str_sub(week_code, 1, 4)),
week = as.integer(str_sub(week_code, 6, 7)),
week_start = MMWRweek2Date(MMWRyear = year, MMWRweek = week)
)
View(X2018)
library(MMWRweek)
install.packages("MMWRweek")
library(MMWRweek)
cdc <- death_all %>%   # <-- replace with your object name
rename(
state = `Residence State`,
week_code = `MMWR Week Code`,
death_count = Deaths
) %>%
# Make sure week_code is formatted exactly like NOAA
mutate(
year = as.integer(str_sub(week_code, 1, 4)),
week = as.integer(str_sub(week_code, 6, 7)),
week_start = MMWRweek2Date(MMWRyear = year, MMWRweek = week)
)
cdc_fixed <- cdc %>%   # <-- use the actual name of your CDC data frame
mutate(
year = as.integer(str_sub(week_code, 1, 4)),
week = as.integer(str_sub(week_code, 6, 7)),
week_start = MMWRweek2Date(MMWRyear = year, MMWRweek = week)
)
cdc_tmp <- cdc %>%   # <- use your actual CDC data frame name
mutate(
year = as.integer(str_sub(week_code, 1, 4)),
week = as.integer(str_sub(week_code, 6, 7))
)
# See all week values and how often they appear
cdc_tmp %>%
count(week, sort = TRUE)
# Look specifically at bad weeks
cdc_tmp %>%
filter(is.na(week) | week <= 0 | week >= 54) %>%
distinct(week_code, week)
cdc_fixed <- cdc_tmp %>%
# keep only valid MMWR weeks 1–53
filter(!is.na(week), week >= 1, week <= 53) %>%
mutate(
week_start = MMWRweek2Date(MMWRyear = year, MMWRweek = week)
)
merged <- cdc_fixed %>%
left_join(
temp_all %>% select(state, week_start, tmean_week_C, tmean_week_F),
by = c("state", "week_start")
)
temp_all
merged <- cdc_fixed %>%
left_join(
noaa %>% select(state, week_start, tmean_week_C, tmean_week_F),
by = c("state", "week_start")
)
glimpse(merged)
weather_clean <- weekly_temp %>%
# if your column is named differently, change week_start here
mutate(
year  = year(week_start),
week  = sprintf("%02d", isoweek(week_start)),  # 1 → "01", etc.
week_code = paste0(year, "/", week)
) %>%
select(state, week_code, everything())
death_clean <- death_all %>%
rename(
state     = `Occurrence State`,
week_code = `MMWR Week Code`
)
death_clean <- death_all %>%
rename(
state     = `Residence State`,
week_code = `MMWR Week Code`
)
death_weather <- death_clean %>%
left_join(
weather_clean,
by = c("state", "week_code")
)
glimpse(death_weather)
merged <- death_weather %>%
mutate(
age_group3 = case_when(
`Ten-Year Age Groups Code` %in% c("Under 1 year", "1-4", "5-14") ~ "<15",
`Ten-Year Age Groups Code` %in% c("15-24", "25-34", "35-44", "45-54", "55-64") ~ "15-64",
`Ten-Year Age Groups Code` %in% c("65-74", "75-84", "85+") ~ "65+",
TRUE ~ NA_character_
),
age_group3 = factor(age_group3, levels = c("<15", "15-64", "65+"))
)
clean_df <- merged %>%
select(
state,
week_code,
week_start,
death_count,
tmean_week_C,
tmean_week_F,
age_group3
)
clean_df <- merged %>%
select(
state,
week_code,
week_start,
Deaths,
tmean_week_C,
tmean_week_F,
age_group3
)
write.csv(clean_df,"weatherAge.csv")
glimpse(clean_df)
library(MASS)
model1 <- glm.nb(
Deaths ~ tmean_week_C,
data = merged
)
summary(model1)
model2 <- glm.nb(
Deaths ~ tmean_week_C + state,
data = merged
)
summary(model2)
model3 <- glm.nb(
Deaths ~ tmean_week_C * age_group3 + state,
data = merged
)
summary(model3)
merged <- clean_df %>%
mutate(
month = month(week_start),
season = case_when(
month %in% c(12, 1, 2) ~ "Winter",
month %in% c(3, 4, 5) ~ "Spring",
month %in% c(6, 7, 8) ~ "Summer",
month %in% c(9, 10, 11) ~ "Fall",
TRUE ~ NA_character_
)
)
model2 <- glm.nb(
Deaths ~ tmean_week_C + state + season,
data = merged
)
summary(model2)
model3 <- glm.nb(
Deaths ~ tmean_week_C * age_group3 + state + season,
data = merged
)
summary(model3)
library(mgcv)
model4 <- gam(
Deaths ~ s(tmean_week_C, k = 10) + state + season,
family = nb(),
data = merged
)
summary(model4)
library(ggplot2)
temp_vals <- data.frame(tmean_week_C = seq(min(merged$tmean_week_C),
max(merged$tmean_week_C), length.out = 300))
merged_clean <- merged %>%
filter(
!is.na(tmean_week_C),
!is.na(Deaths),
is.finite(tmean_week_C)
)
# Check that the range now works:
range(merged_clean$tmean_week_C)
model_nb <- glm.nb(
Deaths ~ tmean_week_C,
data = merged_clean
)
summary(model_nb)
library(ggplot2)
ggplot(merged_clean, aes(tmean_week_C, Deaths)) +
geom_point(alpha = 0.2) +
geom_smooth(method = "glm",
method.args = list(family = MASS::negative.binomial(theta = model_nb$theta))) +
labs(
x = "Weekly mean temperature (°C)",
y = "Weekly deaths",
title = "Relationship between temperature and deaths"
) +
theme_minimal()
temp_vals <- data.frame(
tmean_week_C = seq(
min(merged_clean$tmean_week_C),
max(merged_clean$tmean_week_C),
length.out = 300
)
)
temp_vals$pred_deaths <- predict(
model_nb,
newdata = temp_vals,
type = "response"
)
ggplot(temp_vals, aes(tmean_week_C, pred_deaths)) +
geom_line(size = 1.2) +
labs(
x = "Weekly mean temperature (°C)",
y = "Predicted deaths",
title = "Predicted deaths vs temperature"
) +
theme_minimal()
temp_vals <- data.frame(
tmean_week_C = seq(
min(merged_clean$tmean_week_C),
max(merged_clean$tmean_week_C),
length.out = 300
)
)
temp_vals$pred_deaths <- predict(
model_nb,
newdata = temp_vals,
type = "response"
)
ggplot(temp_vals, aes(tmean_week_C, pred_deaths)) +
geom_line(size = 1.2) +
labs(
x = "Weekly mean temperature (°C)",
y = "Predicted deaths",
title = "Predicted deaths vs temperature"
) +
theme_minimal()
overall_effect <- (exp(coef(model_overall)["tmean_week_C"]) - 1) * 100
overall_effect <- (exp(coef(model1)["tmean_week_C"]) - 1) * 100
overall_effect
model3 <- glm.nb(
Deaths ~ tmean_week_C * age_group3,
data = merged
)
summary(model3)
# Effect for <15 (baseline)
exp(coef(model_age)["tmean_week_C"]) - 1
model_age <- glm.nb(
Deaths ~ tmean_week_C * age_group3,
data = merged
)
summary(model_age)
# Effect for <15 (baseline)
exp(coef(model_age)["tmean_week_C"]) - 1
# Effect for 15-64
exp(coef(model_age)["tmean_week_C"] +
coef(model_age)["tmean_week_C:age_group315-64"]) - 1
# Effect for 65+
exp(coef(model_age)["tmean_week_C"] +
coef(model_age)["tmean_week_C:age_group365+"]) - 1
ggplot(merged_clean, aes(tmean_week_C, Deaths, color = age_group3)) +
geom_point(alpha = 0.15) +
geom_smooth(method = "glm",
method.args = list(family = MASS::negative.binomial(theta = model_age$theta))) +
theme_minimal() +
labs(
title = "Temperature–Death Relationship by Age Group",
x = "Weekly Temperature (°C)",
y = "Deaths"
)
install.packages("glmmTMB")
library(glmmTMB)
model_state_rs <- glmmTMB(
Deaths ~ tmean_week_C + (tmean_week_C | state),
family = nbinom2,
data = merged_clean
)
summary(model_state_rs)
library(broom.mixed)
state_effects <- broom.mixed::tidy(model_state_rs, effects = "ran_vals") %>%
filter(term == "tmean_week_C") %>%
mutate(
temp_effect_percent = (exp(estimate) - 1) * 100
)
state_effects
ggplot(state_effects, aes(reorder(level, temp_effect_percent), temp_effect_percent)) +
geom_point() +
coord_flip() +
labs(
title = "State-Specific Temperature Effects on Weekly Deaths",
x = "State",
y = "% change in deaths per 1°C"
) +
theme_minimal()
library(broom.mixed)
state_effects <- broom.mixed::tidy(model_state_rs, effects = "ran_vals") %>%
filter(term == "tmean_week_C") %>%
mutate(
temp_slope = estimate + fixef(model_state_rs)$cond["tmean_week_C"],
pct_change = (exp(temp_slope) - 1) * 100
)
ggplot(state_effects, aes(reorder(level, temp_effect_percent), temp_effect_percent)) +
geom_point() +
coord_flip() +
labs(
title = "State-Specific Temperature Effects on Weekly Deaths",
x = "State",
y = "% change in deaths per 1°C"
) +
theme_minimal()
ggplot(state_effects, aes(x = pct_change, y = reorder(level, pct_change))) +
geom_point(size = 2) +
labs(
title = "State-Specific Temperature Effects on Weekly Deaths",
x = "% change in deaths per 1°C",
y = "State"
) +
theme_minimal()
state_effects
library(mgcv)
gam_model <- gam(
Deaths ~ s(tmean_week_C, k = 20) + s(state, bs = "re"),
family = nb(),
data = merged_clean
)
library(mgcv)
model_quad <- glmmTMB(
Deaths ~ tmean_week_C + I(tmean_week_C^2) + (1 | state),
family = nbinom2,
data = merged_clean
)
summary(model_quad)
b1 <- fixef(model_quad)$cond["tmean_week_C"]
b2 <- fixef(model_quad)$cond["I(tmean_week_C^2)"]
cut_temp_C <- -b1 / (2 * b2)
cut_temp_C
temp_seq <- seq(
min(merged_clean$tmean_week_C, na.rm = TRUE),
max(merged_clean$tmean_week_C, na.rm = TRUE),
length.out = 300
)
pred_df <- data.frame(
tmean_week_C = temp_seq,
state = factor(NA, levels = levels(merged_clean$state))  # random intercept avg
)
pred_df$pred_deaths <- predict(
model_quad,
newdata = pred_df,
type = "response",
allow.new.levels = TRUE
)
ggplot(pred_df, aes(tmean_week_C, pred_deaths)) +
geom_line(size = 1.1) +
geom_vline(xintercept = cut_temp_C,
linetype = "dashed",
color = "red",
size = 1) +
labs(
title = "Temperature–Mortality Curve with Cut-off Point",
subtitle = paste0("Red dashed line: ", round(cut_temp_C, 1), " °C"),
x = "Weekly mean temperature (°C)",
y = "Predicted weekly deaths"
) +
theme_minimal(base_size = 14)
