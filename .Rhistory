library(broom)
coef_df <- broom::tidy(model_nb) %>%
filter(grepl("^state", term)) %>%
mutate(state = gsub("state", "", term))
ggplot(coef_df, aes(estimate, reorder(state, estimate))) +
geom_point(color = "#e31a1c", size = 2.5) +
geom_errorbarh(aes(xmin = estimate - std.error,
xmax = estimate + std.error),
height = 0.2) +
labs(
title = "State-Level Effects on Deaths (Adjusted)",
x = "Effect on log(Deaths)",
y = "State"
) +
theme_minimal(base_size = 13)
library(broom)
library(dplyr)
library(ggplot2)
library(sf)
library(stringr)
# 1. Extract state coefficients
coef_state <- broom::tidy(model_nb) %>%
dplyr::filter(str_detect(term, "^state")) %>%
dplyr::mutate(
state = gsub("^state", "", term)
) %>%
dplyr::select(state, estimate)
# 2. Add baseline state (Alabama is reference level)
baseline <- tibble(
state = "Alabama",
estimate = 0
)
coef_state_full <- dplyr::bind_rows(coef_state, baseline)
# 3. Load US state shapes (sf)
us_states <- st_as_sf(maps::map("state", fill = TRUE, plot = FALSE))
us_states$state <- tools::toTitleCase(us_states$ID)
# IMPORTANT: fix state name mismatches
coef_state_full <- coef_state_full %>%
dplyr::mutate(state = case_when(
state == "District of Columbia" ~ "District Of Columbia",
TRUE ~ state
))
# 4. Join coefficients to spatial data
map_df <- us_states %>%
dplyr::left_join(coef_state_full, by = "state")
# 5. Plot
ggplot(map_df) +
geom_sf(aes(fill = estimate), color = "white", size = 0.2) +
scale_fill_gradient2(
low = "blue",
high = "red",
mid = "white",
midpoint = 0,
na.value = "grey90",
name = "Effect on log(Deaths)"
) +
labs(
title = "State Effects on Deaths\nAdjusted for Temperature and Season",
fill = "Coefficient"
) +
theme_minimal(base_size = 14) +
theme(
axis.text = element_blank(),
panel.grid = element_blank(),
plot.title = element_text(hjust = 0.5)
)
death_ca <- death %>%
filter(state == "Minnesota") %>%
filter(!is.na(tmean_week_C),
!is.na(Deaths),
is.finite(tmean_week_C))
## Optional: check range
summary(death_ca$tmean_week_C)
## 2. Fit a GAM for California ----
model_gam_ca <- gam(
Deaths ~ s(tmean_week_C, k = 10),
family = nb(),         # negative binomial
data = death_ca
)
summary(model_gam_ca)
## 3. Build temperature grid & predict smooth ----
temp_range_ca <- range(death_ca$tmean_week_C, na.rm = TRUE)
temp_grid_ca <- data.frame(
tmean_week_C = seq(temp_range_ca[1], temp_range_ca[2], length.out = 500)
)
pred_ca <- predict(
model_gam_ca,
newdata = temp_grid_ca,
type = "link",   # smooth on log scale
se.fit = TRUE
)
## 4. Approximate derivative & find cut-point(s) ----
derivative_ca <- diff(pred_ca$fit) / diff(temp_grid_ca$tmean_week_C)
# indices where slope changes sign
sign_change_index_ca <- which(diff(sign(derivative_ca)) != 0)
cut_points_ca <- temp_grid_ca$tmean_week_C[sign_change_index_ca]
cut_points_ca
# This prints the temperature(s) where the curve switches direction
## 5. Prepare data for plotting ----
plot_df_ca <- data.frame(
tmean_week_C = temp_grid_ca$tmean_week_C,
fit = pred_ca$fit
)
## 6. Plot smooth effect + cut-point(s) ----
ggplot(plot_df_ca, aes(x = tmean_week_C, y = fit)) +
geom_line(size = 1) +
geom_vline(xintercept = cut_points_ca,
linetype = "dashed",
color = "red") +
labs(
title = "Nonlinear Effect of Temperature on Deaths in California",
subtitle = "Red dashed line(s) show temperature cut-point(s)",
x = "Temperature (°C)",
y = "Smooth effect on log(Deaths)"
) +
theme_minimal(base_size = 14)
death_ca <- death %>%
filter(state == "Wisconsin") %>%
filter(!is.na(tmean_week_C),
!is.na(Deaths),
is.finite(tmean_week_C))
## Optional: check range
summary(death_ca$tmean_week_C)
## 2. Fit a GAM for California ----
model_gam_ca <- gam(
Deaths ~ s(tmean_week_C, k = 10),
family = nb(),         # negative binomial
data = death_ca
)
summary(model_gam_ca)
## 3. Build temperature grid & predict smooth ----
temp_range_ca <- range(death_ca$tmean_week_C, na.rm = TRUE)
temp_grid_ca <- data.frame(
tmean_week_C = seq(temp_range_ca[1], temp_range_ca[2], length.out = 500)
)
pred_ca <- predict(
model_gam_ca,
newdata = temp_grid_ca,
type = "link",   # smooth on log scale
se.fit = TRUE
)
## 4. Approximate derivative & find cut-point(s) ----
derivative_ca <- diff(pred_ca$fit) / diff(temp_grid_ca$tmean_week_C)
# indices where slope changes sign
sign_change_index_ca <- which(diff(sign(derivative_ca)) != 0)
cut_points_ca <- temp_grid_ca$tmean_week_C[sign_change_index_ca]
cut_points_ca
# This prints the temperature(s) where the curve switches direction
## 5. Prepare data for plotting ----
plot_df_ca <- data.frame(
tmean_week_C = temp_grid_ca$tmean_week_C,
fit = pred_ca$fit
)
## 6. Plot smooth effect + cut-point(s) ----
ggplot(plot_df_ca, aes(x = tmean_week_C, y = fit)) +
geom_line(size = 1) +
geom_vline(xintercept = cut_points_ca,
linetype = "dashed",
color = "red") +
labs(
title = "Nonlinear Effect of Temperature on Deaths in California",
subtitle = "Red dashed line(s) show temperature cut-point(s)",
x = "Temperature (°C)",
y = "Smooth effect on log(Deaths)"
) +
theme_minimal(base_size = 14)
death_ca <- death %>%
filter(state == "Alabama") %>%
filter(!is.na(tmean_week_C),
!is.na(Deaths),
is.finite(tmean_week_C))
## Optional: check range
summary(death_ca$tmean_week_C)
## 2. Fit a GAM for California ----
model_gam_ca <- gam(
Deaths ~ s(tmean_week_C, k = 10),
family = nb(),         # negative binomial
data = death_ca
)
summary(model_gam_ca)
## 3. Build temperature grid & predict smooth ----
temp_range_ca <- range(death_ca$tmean_week_C, na.rm = TRUE)
temp_grid_ca <- data.frame(
tmean_week_C = seq(temp_range_ca[1], temp_range_ca[2], length.out = 500)
)
pred_ca <- predict(
model_gam_ca,
newdata = temp_grid_ca,
type = "link",   # smooth on log scale
se.fit = TRUE
)
## 4. Approximate derivative & find cut-point(s) ----
derivative_ca <- diff(pred_ca$fit) / diff(temp_grid_ca$tmean_week_C)
# indices where slope changes sign
sign_change_index_ca <- which(diff(sign(derivative_ca)) != 0)
cut_points_ca <- temp_grid_ca$tmean_week_C[sign_change_index_ca]
cut_points_ca
# This prints the temperature(s) where the curve switches direction
## 5. Prepare data for plotting ----
plot_df_ca <- data.frame(
tmean_week_C = temp_grid_ca$tmean_week_C,
fit = pred_ca$fit
)
## 6. Plot smooth effect + cut-point(s) ----
ggplot(plot_df_ca, aes(x = tmean_week_C, y = fit)) +
geom_line(size = 1) +
geom_vline(xintercept = cut_points_ca,
linetype = "dashed",
color = "red") +
labs(
title = "Nonlinear Effect of Temperature on Deaths in California",
subtitle = "Red dashed line(s) show temperature cut-point(s)",
x = "Temperature (°C)",
y = "Smooth effect on log(Deaths)"
) +
theme_minimal(base_size = 14)
death_ca <- death %>%
filter(state == "Pennsylvania") %>%
filter(!is.na(tmean_week_C),
!is.na(Deaths),
is.finite(tmean_week_C))
## Optional: check range
summary(death_ca$tmean_week_C)
## 2. Fit a GAM for California ----
model_gam_ca <- gam(
Deaths ~ s(tmean_week_C, k = 10),
family = nb(),         # negative binomial
data = death_ca
)
summary(model_gam_ca)
## 3. Build temperature grid & predict smooth ----
temp_range_ca <- range(death_ca$tmean_week_C, na.rm = TRUE)
temp_grid_ca <- data.frame(
tmean_week_C = seq(temp_range_ca[1], temp_range_ca[2], length.out = 500)
)
pred_ca <- predict(
model_gam_ca,
newdata = temp_grid_ca,
type = "link",   # smooth on log scale
se.fit = TRUE
)
## 4. Approximate derivative & find cut-point(s) ----
derivative_ca <- diff(pred_ca$fit) / diff(temp_grid_ca$tmean_week_C)
# indices where slope changes sign
sign_change_index_ca <- which(diff(sign(derivative_ca)) != 0)
cut_points_ca <- temp_grid_ca$tmean_week_C[sign_change_index_ca]
cut_points_ca
# This prints the temperature(s) where the curve switches direction
## 5. Prepare data for plotting ----
plot_df_ca <- data.frame(
tmean_week_C = temp_grid_ca$tmean_week_C,
fit = pred_ca$fit
)
## 6. Plot smooth effect + cut-point(s) ----
ggplot(plot_df_ca, aes(x = tmean_week_C, y = fit)) +
geom_line(size = 1) +
geom_vline(xintercept = cut_points_ca,
linetype = "dashed",
color = "red") +
labs(
title = "Nonlinear Effect of Temperature on Deaths in California",
subtitle = "Red dashed line(s) show temperature cut-point(s)",
x = "Temperature (°C)",
y = "Smooth effect on log(Deaths)"
) +
theme_minimal(base_size = 14)
death_ca <- death %>%
filter(state == "Texas") %>%
filter(!is.na(tmean_week_C),
!is.na(Deaths),
is.finite(tmean_week_C))
## Optional: check range
summary(death_ca$tmean_week_C)
## 2. Fit a GAM for California ----
model_gam_ca <- gam(
Deaths ~ s(tmean_week_C, k = 10),
family = nb(),         # negative binomial
data = death_ca
)
summary(model_gam_ca)
## 3. Build temperature grid & predict smooth ----
temp_range_ca <- range(death_ca$tmean_week_C, na.rm = TRUE)
temp_grid_ca <- data.frame(
tmean_week_C = seq(temp_range_ca[1], temp_range_ca[2], length.out = 500)
)
pred_ca <- predict(
model_gam_ca,
newdata = temp_grid_ca,
type = "link",   # smooth on log scale
se.fit = TRUE
)
## 4. Approximate derivative & find cut-point(s) ----
derivative_ca <- diff(pred_ca$fit) / diff(temp_grid_ca$tmean_week_C)
# indices where slope changes sign
sign_change_index_ca <- which(diff(sign(derivative_ca)) != 0)
cut_points_ca <- temp_grid_ca$tmean_week_C[sign_change_index_ca]
cut_points_ca
# This prints the temperature(s) where the curve switches direction
## 5. Prepare data for plotting ----
plot_df_ca <- data.frame(
tmean_week_C = temp_grid_ca$tmean_week_C,
fit = pred_ca$fit
)
## 6. Plot smooth effect + cut-point(s) ----
ggplot(plot_df_ca, aes(x = tmean_week_C, y = fit)) +
geom_line(size = 1) +
geom_vline(xintercept = cut_points_ca,
linetype = "dashed",
color = "red") +
labs(
title = "Nonlinear Effect of Temperature on Deaths in California",
subtitle = "Red dashed line(s) show temperature cut-point(s)",
x = "Temperature (°C)",
y = "Smooth effect on log(Deaths)"
) +
theme_minimal(base_size = 14)
death_ca <- death %>%
filter(state == "Florida") %>%
filter(!is.na(tmean_week_C),
!is.na(Deaths),
is.finite(tmean_week_C))
## Optional: check range
summary(death_ca$tmean_week_C)
## 2. Fit a GAM for California ----
model_gam_ca <- gam(
Deaths ~ s(tmean_week_C, k = 10),
family = nb(),         # negative binomial
data = death_ca
)
summary(model_gam_ca)
## 3. Build temperature grid & predict smooth ----
temp_range_ca <- range(death_ca$tmean_week_C, na.rm = TRUE)
temp_grid_ca <- data.frame(
tmean_week_C = seq(temp_range_ca[1], temp_range_ca[2], length.out = 500)
)
pred_ca <- predict(
model_gam_ca,
newdata = temp_grid_ca,
type = "link",   # smooth on log scale
se.fit = TRUE
)
## 4. Approximate derivative & find cut-point(s) ----
derivative_ca <- diff(pred_ca$fit) / diff(temp_grid_ca$tmean_week_C)
# indices where slope changes sign
sign_change_index_ca <- which(diff(sign(derivative_ca)) != 0)
cut_points_ca <- temp_grid_ca$tmean_week_C[sign_change_index_ca]
cut_points_ca
# This prints the temperature(s) where the curve switches direction
## 5. Prepare data for plotting ----
plot_df_ca <- data.frame(
tmean_week_C = temp_grid_ca$tmean_week_C,
fit = pred_ca$fit
)
## 6. Plot smooth effect + cut-point(s) ----
ggplot(plot_df_ca, aes(x = tmean_week_C, y = fit)) +
geom_line(size = 1) +
geom_vline(xintercept = cut_points_ca,
linetype = "dashed",
color = "red") +
labs(
title = "Nonlinear Effect of Temperature on Deaths in California",
subtitle = "Red dashed line(s) show temperature cut-point(s)",
x = "Temperature (°C)",
y = "Smooth effect on log(Deaths)"
) +
theme_minimal(base_size = 14)
state_coords <- data.frame(
state = c(
"Alabama","Alaska","Arizona","Arkansas","California",
"Colorado","Connecticut","Delaware","Florida","Georgia",
"Hawaii","Idaho","Illinois","Indiana","Iowa",
"Kansas","Kentucky","Louisiana","Maine","Maryland",
"Massachusetts","Michigan","Minnesota","Mississippi","Missouri",
"Montana","Nebraska","Nevada","New Hampshire","New Jersey",
"New Mexico","New York","North Carolina","North Dakota","Ohio",
"Oklahoma","Oregon","Pennsylvania","Rhode Island","South Carolina",
"South Dakota","Tennessee","Texas","Utah","Vermont",
"Virginia","Washington","West Virginia","Wisconsin","Wyoming"
),
lat = c(
32.37, 58.30, 33.45, 34.75, 38.58,
39.74, 41.76, 39.74, 30.44, 33.75,
21.31, 43.62, 39.80, 39.77, 41.59,
39.04, 38.20, 30.46, 44.31, 39.29,
42.36, 42.73, 44.95, 32.30, 38.57,
46.59, 40.81, 39.16, 43.21, 40.22,
35.69, 42.65, 35.78, 46.81, 39.96,
35.47, 44.94, 40.27, 41.82, 34.00,
44.37, 36.17, 30.27, 40.76, 44.26,
37.54, 47.04, 38.35, 43.07, 41.14
),
lon = c(
-86.30, -134.42, -112.07, -92.29, -121.49,
-104.99, -72.68, -75.55, -84.28, -84.39,
-157.86, -116.21, -89.65, -86.16, -93.62,
-95.69, -84.87, -91.14, -69.78, -76.61,
-71.06, -84.56, -93.09, -90.18, -92.17,
-112.02, -96.70, -119.77, -71.54, -74.76,
-105.94, -73.76, -78.64, -100.78, -82.99,
-97.52, -123.03, -76.88, -71.41, -81.03,
-100.35, -86.78, -97.74, -111.89, -72.58,
-77.43, -122.90, -81.63, -89.40, -104.82
),
stringsAsFactors = FALSE
)
## ------------------------------------------------------------
## 2. Date range and API helper function
## ------------------------------------------------------------
start_date <- "2004-01-01"
end_date   <- "2024-12-31"
get_state_daily <- function(state_name, lat, lon) {
message("Fetching daily data for ", state_name, " ...")
resp <- GET(
url   = "https://archive-api.open-meteo.com/v1/archive",
query = list(
latitude   = lat,
longitude  = lon,
start_date = start_date,
end_date   = end_date,
daily      = "temperature_2m_mean",
timezone   = "auto"
)
)
if (http_error(resp)) {
stop("Weather error for ", state_name, ": ",
status_code(resp), " - ", content(resp, "text"))
}
dat <- fromJSON(content(resp, "text", encoding = "UTF-8"))
if (is.null(dat$daily)) {
warning("No daily data for ", state_name)
return(NULL)
}
# daily$time is a vector of dates; temperature_2m_mean matches length
tibble(
state = state_name,
date  = as.Date(dat$daily$time),
tmean_C = dat$daily$temperature_2m_mean  # degrees Celsius
)
}
## ------------------------------------------------------------
## 3. Loop over all states and combine daily data
## ------------------------------------------------------------
all_daily <- vector("list", nrow(state_coords))
for (i in seq_len(nrow(state_coords))) {
s   <- state_coords$state[i]
lat <- state_coords$lat[i]
lon <- state_coords$lon[i]
success <- FALSE
attempt <- 1
while (!success) {
message("Fetching ", s, " (attempt ", attempt, ") ...")
resp <- try(
GET(
url   = "https://archive-api.open-meteo.com/v1/archive",
query = list(
latitude   = lat,
longitude  = lon,
start_date = start_date,
end_date   = end_date,
daily      = "temperature_2m_mean",
timezone   = "auto"
)
),
silent = TRUE
)
# If GET failed entirely
if (inherits(resp, "try-error")) {
message("GET error, retrying in 5 sec...")
Sys.sleep(5)
attempt <- attempt + 1
next
}
# If API limit exceeded → retry after waiting
if (status_code(resp) == 429) {
message("Rate limit hit. Waiting 10 sec before retry...")
Sys.sleep(10)
attempt <- attempt + 1
next
}
# If other http error → stop
if (http_error(resp)) {
stop("Fatal error for ", s, ": ", status_code(resp), " - ",
content(resp, "text", encoding = "UTF-8"))
}
# Parse response
dat <- fromJSON(content(resp, "text", encoding = "UTF-8"))
if (is.null(dat$daily)) {
warning("No data for ", s)
all_daily[[i]] <- NULL
success <- TRUE
next
}
all_daily[[i]] <- tibble(
state = s,
date  = as.Date(dat$daily$time),
tmean_C = dat$daily$temperature_2m_mean
)
success <- TRUE
# Small pause before next state
Sys.sleep(2)
}
}
daily_temps <- bind_rows(all_daily)
weekly_temps <- daily_temps %>%
mutate(week_start = floor_date(date, "week", week_start = 1)) %>%
group_by(state, week_start) %>%
summarise(
tmean_week_C = mean(tmean_C, na.rm = TRUE),
.groups = "drop"
) %>%
mutate(tmean_week_F = tmean_week_C * 9/5 + 32)
View(daily_temps)
